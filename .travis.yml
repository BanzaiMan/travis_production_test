# set baseline attributes of this build
language: node_js
node_js: '6.9.1'
sudo: false
dist: trusty

branches:
  only:
    - master

before_script:
  - yarn global add gulp

jobs:
  include:
    # first 2 steps can be combined into one stage, and executes serially
    - stage: prep
      script:
        - gulp build
        - gulp test:detec-exclusive
    # step 3 run in parallel; any failure here will cancel the jobs in
    # the remaining stages
    - stage: unit tests
      script:
        - gulp test:unit:controllers
    - stage: unit tests
      script:
        - gulp test:unit:dataServices
    - stage: unit tests
      script:
        - gulp test:unit:middleware
    - stage: unit tests
      script:
        - gulp test:unit:routes
    - stage: unit tests
      script:
        - gulp test:unit:narrowIntegration
    # We use GCE to run the remaining stages, as they require `docker` command
    - stage: docker build
      sudo: required
      script:
        - export NODE_ENV=development
        # ⋮
        - docker build -t sip-ai:$PACKAGE_VERSION -f Dockerfile
        # ⋮
        - docker push …
        # ⋮
        - gulp test:integration
    # the last 2 steps will run in parallel
    - stage: after success
      sudo: required
      script:
        - export NODE_ENV=demo
        - gulp build:infrastructure --environment $NODE_ENV
        # ⋮
    - stage: after success
      sudo: required
      script:
        - export NODE_ENV=production
        - gulp build:infrastructure

notifications:
  email: false
