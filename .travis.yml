language: bash

sudo: 9000

dist: trusty

env:
  global:
    - DEBIAN_FRONTEND=noninteractive
    - SSH_OPTS='-o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no'

before_install:
  - sudo apt-get update -y -qq
  - sudo apt-get install -yqq lvm2 xfsprogs sshpass
  - if ! command -v docker ; then curl -sSL https://get.docker.io | bash; fi
  - sudo usermod -a -G docker travis
  - docker pull quay.io/travisci/travis-ruby:latest
  - jq --version || sudo curl -sSL -o /usr/local/bin/jq http://stedolan.github.io/jq/download/linux64/jq && sudo chmod 0755 /usr/local/bin/jq
  - docker images | grep -q -E '^travis\\s+\\bruby\\b\\s+' || docker tag quay.io/travisci/travis-ruby:latest travis:ruby
  - docker run -v /var/tmp:/var/tmp -v /home/travis/build:/home/travis/build -d travis:ruby | tee docker_id
  - docker inspect $(< docker_id) | awk -F '"' '/IPAddress/ {print $4}' | tee docker_ip_address
  - docker ps
  - while ! nc -v -z -w 30 $(< docker_ip_address) 22; do sleep 1; done

install:
  - true
  
script:
  - sshpass -p travis ssh -n -t -t $SSH_OPTS travis@$(< docker_ip_address) "git clone https://github.com/sstephenson/rbenv.git ~/.rbenv; echo 'export PATH=\"\$HOME/.rbenv/bin:\$PATH\"' >> ~/.bash_profile; echo 'eval \"\$(rbenv init -)\"' >> ~/.bash_profile"
  - sshpass -p travis ssh -n -t -t $SSH_OPTS travis@$(< docker_ip_address) "git clone https://github.com/sstephenson/ruby-build.git ~/.rbenv/plugins/ruby-build; rbenv install 2.2.0; rbenv global 2.20; which ruby; ruby --version; ruby -rjson -e 'puts 1'"
